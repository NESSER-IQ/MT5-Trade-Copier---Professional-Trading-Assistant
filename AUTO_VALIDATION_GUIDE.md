# 🛡️ نظام التحقق التلقائي من شروط التداول
**التاريخ**: 22 أكتوبر 2025

---

## ✨ الميزة الجديدة

تم إضافة نظام تحقق تلقائي شامل يفحص **جميع شروط التداول** قبل تنفيذ أي صفقة، مما يمنع الأخطاء ويحمي رأس المال.

---

## 🔍 ما يتم التحقق منه تلقائياً

### **1. ✅ هل التداول مسموح؟** (`trade_allowed`)
```python
if not symbol_info.trade_allowed:
    ❌ "التداول غير مسموح على الرمز XAUUSD"
    "السبب المحتمل: السوق مغلق أو الرمز معطل"
```

**متى يحدث:**
- السوق مغلق (عطلة، عطلة نهاية الأسبوع)
- الرمز معطل من قبل الوسيط
- صيانة السيرفر

---

### **2. 🤖 هل التداول عبر الخبراء مسموح؟** (`trade_expert`)
```python
if not symbol_info.trade_expert:
    ❌ "التداول عبر الخبراء غير مسموح على XAUUSD"
    "يجب تفعيل 'Allow Algo Trading' في إعدادات الرمز"
```

**كيفية الإصلاح:**
1. Market Watch → Right Click على الرمز
2. Specification → Allow Algo Trading ✓

---

### **3. 📏 هل مستوى Stops Level يسمح بـ SL/TP قريب؟**
```python
stops_level = symbol_info.trade_stops_level  # مثلاً: 30 نقطة
min_distance = stops_level * point            # 30 * 0.01 = 0.30

# التحقق من SL
sl_distance = abs(entry_price - stop_loss)
if sl_distance < min_distance:
    ❌ "المسافة بين Entry و SL (0.10) أقل من الحد الأدنى (0.30)"
    "Stop Level: 30 نقطة"
    💡 "SL مقترح: 4069.70"
```

**مثال عملي:**
```
Entry: 4070.0
SL: 4069.9    ← فرق 0.1 فقط!
Stop Level: 30 نقطة (0.30)
❌ مرفوض - SL قريب جداً
```

**الحل المقترح:**
```
SL الجديد: 4069.70  (فرق 0.30 = 30 نقطة)
```

---

### **4. 📦 هل حجم الصفقة ضمن المسموح؟**
```python
# الحد الأدنى
if lot_size < symbol_info.volume_min:
    ❌ "حجم الصفقة (0.001) أقل من الحد الأدنى (0.01)"

# الحد الأقصى
if lot_size > symbol_info.volume_max:
    ❌ "حجم الصفقة (150.0) أكبر من الحد الأقصى (100.0)"

# خطوة الحجم
if lot_size != n * volume_step:
    ⚠️ "حجم الصفقة يجب أن يكون من مضاعفات 0.01"
    💡 "القيمة المقترحة: 0.05"
```

**أمثلة:**
- `0.01 ✓` صحيح
- `0.05 ✓` صحيح
- `0.03 ⚠️` قد لا يعمل (خطوة 0.01)
- `0.001 ❌` أقل من الحد الأدنى

---

### **5. 🎯 هل الرمز موجود فعلياً؟**
```python
actual_symbol = find_symbol_in_platform(symbol)
if not actual_symbol:
    ❌ "الرمز XAUUSD غير موجود في المنصة"
    📋 "رموز مشابهة متاحة: XAUUSD.m, XAUUSD#, XAUUSDm"
```

**البحث الذكي:**
- `XAUUSD` → `XAUUSD` ✓
- `XAUUSD` → `XAUUSD.m` ✓
- `GOLD` → `XAUUSD` ✓
- `XXXYYY` → ❌ غير موجود

---

### **6. ↕️ هل السعر الحالي يسمح بتنفيذ SL/TP؟**

#### **أ. التحقق من اتجاه SL**
```python
# في صفقة BUY
if action == 'BUY' and stop_loss >= entry_price:
    ❌ "SL في صفقة BUY يجب أن يكون أقل من Entry"
    "Entry: 4070.0, SL: 4075.0"

# في صفقة SELL
if action == 'SELL' and stop_loss <= entry_price:
    ❌ "SL في صفقة SELL يجب أن يكون أعلى من Entry"
```

#### **ب. التحقق من اتجاه TP**
```python
# في صفقة BUY
if action == 'BUY' and take_profit <= entry_price:
    ❌ "TP في صفقة BUY يجب أن يكون أعلى من Entry"

# في صفقة SELL
if action == 'SELL' and take_profit >= entry_price:
    ❌ "TP في صفقة SELL يجب أن يكون أقل من Entry"
```

---

## 📊 تقرير التحقق

### **مثال: تحقق ناجح ✅**
```
==============================================================
✅ التحقق من شروط التداول: نجح
==============================================================
⚠️ السبريد مرتفع: 35 نقطة
==============================================================
```

### **مثال: تحقق فاشل ❌**
```
==============================================================
❌ التحقق من شروط التداول: فشل
==============================================================
❌ المسافة بين Entry و SL (0.10) أقل من الحد الأدنى (0.30)
   Stop Level: 30 نقطة
❌ حجم الصفقة (0.001) أقل من الحد الأدنى (0.01)

⚠️ تحذيرات:
💡 SL مقترح: 4069.70
⚠️ السبريد مرتفع: 35 نقطة
==============================================================
```

---

## 🔧 واجهة البرمجة

### **دالة `validate_trade_conditions()`**
```python
validation = manager.validate_trade_conditions(
    symbol='XAUUSD',
    action='BUY',
    lot_size=0.01,
    entry_price=4070.0,
    stop_loss=4060.0,
    take_profit=4080.0,
    order_type='MARKET'
)

# النتيجة
{
    'valid': True/False,           # هل الصفقة صالحة؟
    'errors': [...],               # قائمة الأخطاء
    'warnings': [...],             # قائمة التحذيرات
    'symbol_info': <SymbolInfo>,   # معلومات الرمز
    'actual_symbol': 'XAUUSD',     # الرمز الفعلي
    'current_price': 4070.5,       # السعر الحالي
    'min_distance': 0.30           # الحد الأدنى للمسافة
}
```

---

## 🚀 التكامل التلقائي

### **في `execute_signal()`:**
```python
def execute_signal(self, signal: Signal, lot_size: float = 0.01) -> Dict:
    # ... التحقق التلقائي ...
    validation = self.validate_trade_conditions(...)
    
    if not validation['valid']:
        # رفض الصفقة
        return {
            'success': False,
            'error': 'فشل التحقق من شروط التداول',
            'validation_errors': validation['errors']
        }
    
    # متابعة التنفيذ ...
```

### **في `place_pending_order()`:**
```python
def place_pending_order(self, signal: Signal, lot_size: float = 0.01) -> Dict:
    # ... التحقق التلقائي ...
    validation = self.validate_trade_conditions(...)
    
    if not validation['valid']:
        return {'success': False, 'error': '...'}
    
    # متابعة وضع الأمر المعلق ...
```

---

## 🧪 الاختبارات

### **تشغيل الاختبار:**
```bash
python test_validation_system.py
```

### **الاختبارات المضمنة:**
1. ✅ صفقة صحيحة 100%
2. ❌ SL قريب جداً من Entry
3. ❌ حجم صفقة أقل من المسموح
4. ❌ SL في اتجاه خاطئ
5. ❌ رمز غير موجود

### **نتيجة متوقعة:**
```
==============================================================
📊 النتائج النهائية:
   ✅ نجح: 5/5
   ❌ فشل: 0/5
==============================================================

🎉 ممتاز! جميع الاختبارات نجحت!
```

---

## 💡 أمثلة عملية

### **مثال 1: Stop Level صغير جداً**
```python
Signal:
  XAUUSD BUY @ 4070.0
  SL: 4069.9    ← فرق 0.1 فقط
  TP: 4080.0

التحقق:
  Stop Level: 30 نقطة (0.30)
  المسافة الفعلية: 0.10
  ❌ مرفوض
  💡 SL مقترح: 4069.70
```

### **مثال 2: SL في اتجاه خاطئ**
```python
Signal:
  XAUUSD BUY @ 4070.0
  SL: 4075.0    ← أعلى من Entry!
  TP: 4080.0

التحقق:
  ❌ SL في صفقة BUY يجب أن يكون أقل من Entry
```

### **مثال 3: حجم صفقة خاطئ**
```python
Signal:
  XAUUSD BUY
  Lot Size: 0.03    ← ليس من مضاعفات 0.01

التحقق:
  volume_step: 0.01
  ⚠️ حجم الصفقة يجب أن يكون من مضاعفات 0.01
  💡 القيمة المقترحة: 0.03 (صحيحة فعلياً)
```

---

## 📁 الملفات المعدلة

### **`mt5_manager.py`**
- ✅ إضافة `validate_trade_conditions()` - دالة شاملة
- ✅ تكامل التحقق في `execute_signal()`
- ✅ تكامل التحقق في `place_pending_order()`
- ✅ تقارير مفصلة للأخطاء والتحذيرات

### **`test_validation_system.py`** (جديد)
- ✅ 5 اختبارات شاملة
- ✅ اختبار تفصيلي لرمز واحد
- ✅ عرض تقرير النتائج

---

## 🎯 الفوائد

### **1. منع الأخطاء:**
- ✅ لا مزيد من رفض MT5 للأوامر
- ✅ اكتشاف المشاكل قبل الإرسال
- ✅ رسائل خطأ واضحة ومفيدة

### **2. توفير الوقت:**
- ✅ لا حاجة للفحص اليدوي
- ✅ تحذيرات استباقية
- ✅ اقتراحات تلقائية للإصلاح

### **3. حماية رأس المال:**
- ✅ منع صفقات خطرة (SL خاطئ)
- ✅ التحقق من أحجام الصفقات
- ✅ احترام قيود الوسيط

### **4. تحسين الأداء:**
- ✅ تقليل محاولات الفاشلة
- ✅ تنفيذ أسرع (لا إعادة محاولة)
- ✅ سجل واضح للأخطاء

---

## 🚦 قواعد التحقق

### **قواعد إلزامية (تفشل الصفقة):**
1. ❌ التداول غير مسموح
2. ❌ التداول عبر الخبراء معطل
3. ❌ حجم الصفقة خارج النطاق
4. ❌ المسافة أقل من Stop Level
5. ❌ SL/TP في اتجاه خاطئ
6. ❌ الرمز غير موجود

### **تحذيرات (لا تفشل الصفقة):**
1. ⚠️ السبريد مرتفع
2. ⚠️ حجم الصفقة ليس من مضاعفات الخطوة
3. ⚠️ الرمز غير مرئي (سيتم تفعيله)

---

## 🎉 الخلاصة

تم إضافة نظام تحقق تلقائي شامل يفحص **10 شروط مختلفة** قبل كل صفقة:

1. ✅ وجود الرمز
2. ✅ التداول مسموح
3. ✅ التداول عبر الخبراء
4. ✅ حجم الصفقة صحيح
5. ✅ Stop Level محترم
6. ✅ اتجاه SL صحيح
7. ✅ اتجاه TP صحيح
8. ✅ المسافات كافية
9. ✅ الرؤية
10. ✅ السبريد معقول

**النتيجة: حماية شاملة وتنفيذ أكثر أماناً!** 🛡️

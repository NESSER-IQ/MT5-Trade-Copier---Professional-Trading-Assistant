# دليل نظام Trailing Stop الذكي - الإصدار 2.0

## 🎯 نظرة عامة

نظام **Trailing Stop الذكي** يقوم بحماية أرباحك تلقائياً عن طريق تحريك وقف الخسارة (SL) تدريجياً كلما حققت الأهداف.

---

## 📋 آلية العمل الجديدة

### القاعدة الأساسية:

```
TP1  → تحريك SL إلى نقطة الدخول + السبريد ✅
TP2  → لا يتم تحريك SL (يبقى عند نقطة الدخول) ⏸️
TP3  → تحريك SL إلى TP1 ✅
TP4  → تحريك SL إلى TP2 ✅
TP5  → تحريك SL إلى TP3 ✅
...وهكذا
```

---

## 🔍 مثال تفصيلي - صفقة SELL

### الإشارة الأصلية:
```
XAUUSD SELL 4290
TP1: 4287
TP2: 4284
TP3: 4281
TP4: 4278
SL:  4317
```

### سيناريو التنفيذ:

#### 1️⃣ فتح الصفقة
```
السعر الحالي: 4290
SL الأصلي: 4317
TP1: 4287
```

#### 2️⃣ عند تحقيق TP1 (4287)
```
🎯 تم تحقيق TP1!
السعر الحالي: 4287

الإجراء:
✅ تحريك SL من 4317 إلى 4290 + السبريد
   (مثلاً: 4290.5 إذا كان السبريد 0.5)

النتيجة:
✅ الصفقة أصبحت آمنة (لا خسارة)
✅ لو عاد السعر، ستغلق الصفقة عند Break Even
```

#### 3️⃣ عند تحقيق TP2 (4284)
```
🎯 تم تحقيق TP2!
السعر الحالي: 4284

الإجراء:
⏸️ لا يتم تحريك SL
   SL يبقى عند: 4290.5 (نقطة الدخول)

السبب:
نحن نحتفظ بـ SL عند نقطة الدخول لمزيد من الأمان
```

#### 4️⃣ عند تحقيق TP3 (4281)
```
🎯 تم تحقيق TP3!
السعر الحالي: 4281

الإجراء:
✅ تحريك SL من 4290.5 إلى TP1 (4287)

النتيجة:
✅ ضمان ربح +3 نقاط على الأقل
✅ لو عاد السعر، ستغلق الصفقة عند 4287
```

#### 5️⃣ عند تحقيق TP4 (4278)
```
🎯 تم تحقيق TP4!
السعر الحالي: 4278

الإجراء:
✅ تحريك SL من 4287 إلى TP2 (4284)

النتيجة:
✅ ضمان ربح +6 نقاط على الأقل
✅ لو عاد السعر، ستغلق الصفقة عند 4284
```

---

## 📊 جدول ملخص

| الحدث | TP المحقق | SL القديم | SL الجديد | الربح المضمون |
|-------|-----------|-----------|-----------|---------------|
| فتح الصفقة | - | 4317 | 4317 | لا يوجد |
| تحقيق TP1 | 4287 | 4317 | 4290.5 | 0 (Break Even) |
| تحقيق TP2 | 4284 | 4290.5 | 4290.5 | 0 (لا تغيير) |
| تحقيق TP3 | 4281 | 4290.5 | 4287 | +3 نقاط |
| تحقيق TP4 | 4278 | 4287 | 4284 | +6 نقاط |

---

## 🔧 الكود المسؤول

### في [mt5_manager.py](mt5_manager.py#L327-L375):

```python
def _calculate_new_sl(self, signal: Signal, current_tp_index: int, entry_price: float):
    """حساب SL الجديد"""

    # حساب السبريد
    symbol_info = mt5.symbol_info(signal.symbol)
    spread = symbol_info.spread * symbol_info.point if symbol_info else 0

    if current_tp_index == 0:
        # TP1: نحرك SL إلى نقطة الدخول + السبريد
        if signal.action == 'BUY':
            return entry_price + spread
        else:
            return entry_price - spread

    elif current_tp_index == 1:
        # TP2: لا نحرك SL
        return None

    elif current_tp_index >= 2:
        # من TP3 فصاعداً: نحرك SL إلى TP السابق بمقدار 2
        target_tp_index = current_tp_index - 2
        return signal.take_profits[target_tp_index]
```

---

## 🎮 كيفية الاستخدام

### 1. تلقائي (افتراضي)
النظام يعمل **تلقائياً** بمجرد الاتصال بـ MT5. لا تحتاج لعمل أي شيء!

### 2. التحقق من عمل النظام
راقب السجل (Console) لرؤية الرسائل:

```
✅ تم تشغيل نظام Trailing Stop
🎯 الصفقة 12345: تم تحقيق TP1 عند 4287
📊 TP1 تم تحقيقه - تحريك SL إلى نقطة الدخول + السبريد: 4290.50000
📉 تم تحريك SL للصفقة 12345 من 4317.00000 إلى 4290.50000
```

### 3. في الواجهة
- اذهب إلى تبويب "الصفقات المفتوحة"
- ستشاهد SL يتحرك تلقائياً عند تحقيق الأهداف

---

## ⚙️ الإعدادات

### تردد الفحص
النظام يفحص الصفقات كل **2 ثانية** لتحديث SL.

```python
# في mt5_manager.py
time.sleep(2)  # فحص كل 2 ثانية
```

لتغيير التردد، عدّل هذا الرقم:
- `1` = فحص كل ثانية (أسرع لكن يستهلك موارد أكثر)
- `5` = فحص كل 5 ثواني (أبطأ لكن يستهلك موارد أقل)

---

## 🛡️ مميزات النظام

### ✅ المميزات:

1. **حماية الأرباح تلقائياً**
   - لا تحتاج للتدخل اليدوي
   - يعمل 24/7

2. **تحريك ذكي**
   - TP1 → Break Even (حماية رأس المال)
   - TP2 → انتظار (استقرار)
   - TP3+ → تأمين الأرباح التدريجي

3. **حساب السبريد**
   - يأخذ السبريد في الاعتبار
   - يمنع الإغلاق المبكر بسبب السبريد

4. **متوافق مع جميع الأصول**
   - XAUUSD (الذهب)
   - الفوركس
   - المؤشرات
   - العملات الرقمية

---

## 📈 أمثلة إضافية

### مثال 2: صفقة BUY

```
XAUUSD BUY 4218
TP1: 4222
TP2: 4226
TP3: 4230
TP4: 4233
SL: 4205
```

**التنفيذ:**
- TP1 (4222) → SL إلى 4218 + السبريد (مثلاً 4218.5)
- TP2 (4226) → SL يبقى عند 4218.5
- TP3 (4230) → SL إلى TP1 (4222)
- TP4 (4233) → SL إلى TP2 (4226)

---

### مثال 3: إشارة بـ 6 أهداف

```
XAUUSD SELL 4300
TP1: 4295
TP2: 4290
TP3: 4285
TP4: 4280
TP5: 4275
TP6: 4270
SL: 4320
```

**التنفيذ:**
- TP1 → SL إلى 4300.5 (Break Even)
- TP2 → SL يبقى عند 4300.5
- TP3 → SL إلى TP1 (4295)
- TP4 → SL إلى TP2 (4290)
- TP5 → SL إلى TP3 (4285)
- TP6 → SL إلى TP4 (4280)

---

## 🔍 استكشاف الأخطاء

### المشكلة: SL لا يتحرك

**الأسباب المحتملة:**

1. **النظام معطل**
   ```
   السجل: ⚠️ لم يتم تشغيل نظام Trailing Stop
   الحل: أعد الاتصال بـ MT5
   ```

2. **لم يتحقق TP بعد**
   ```
   راقب السجل - يجب أن ترى:
   🎯 الصفقة X: تم تحقيق TP1 عند Y
   ```

3. **السعر لم يصل لـ TP**
   ```
   تحقق من السعر الحالي في MT5
   للشراء: السعر يجب أن يكون >= TP
   للبيع: السعر يجب أن يكون <= TP
   ```

4. **خطأ في تعديل الصفقة**
   ```
   السجل: ⚠️ فشل تعديل الصفقة
   السبب: قد يكون SL قريب جداً من السعر الحالي
   ```

---

### المشكلة: SL يتحرك إلى مكان خاطئ

**التحقق:**
```python
# شغل هذا الكود للتأكد من القيم
from mt5_manager import MT5Manager

manager = MT5Manager()
# افحص active_positions
print(manager.active_positions)
```

---

## 📝 سجل التغييرات

### الإصدار 2.0 (الحالي)
- ✅ إضافة حساب السبريد
- ✅ تحسين منطق TP2 (عدم التحريك)
- ✅ إضافة رسائل مفصلة في السجل
- ✅ تحسين معالجة الأخطاء

### الإصدار 1.0 (السابق)
- TP1 → Break Even
- TP2+ → تحريك إلى TP السابق مباشرة

**الفرق:**
- القديم: TP2 يحرك SL إلى TP1 ❌
- الجديد: TP2 لا يحرك SL ✅

---

## 💡 نصائح مهمة

### 1. اختبر على حساب تجريبي أولاً
قبل استخدام النظام على حساب حقيقي:
- افتح حساب Demo
- جرّب عدة إشارات
- راقب سلوك SL

### 2. راقب السجل بانتظام
السجل (Console) يعطيك معلومات مهمة:
```
✅ = نجح
⚠️ = تحذير
❌ = خطأ
🎯 = تحقيق هدف
📈/📉 = تحريك SL
```

### 3. تحقق من الصفقات يدوياً
من وقت لآخر، تحقق من الصفقات في MT5 مباشرة للتأكد.

### 4. احتفظ بسجل
النظام يحفظ جميع الصفقات في:
```
data/trades.json
```

راجعه لفهم الأداء.

---

## 🚨 تحذيرات مهمة

### ⚠️ لا تعدل SL يدوياً
إذا عدّلت SL يدوياً في MT5، قد يتعارض مع النظام التلقائي.

### ⚠️ انتبه للسبريد في الأخبار
عند الأخبار الهامة، السبريد قد يتسع كثيراً. قد يُغلق النظام الصفقة مبكراً.

### ⚠️ تأكد من استقرار الاتصال
إذا انقطع الاتصال بالإنترنت، سيتوقف النظام مؤقتاً حتى عودة الاتصال.

---

## 📞 الدعم

إذا واجهت مشاكل:
1. راجع السجل (Console)
2. تحقق من `data/trades.json`
3. راجع هذا الدليل
4. أعد تشغيل البرنامج

---

## ✨ الخلاصة

نظام **Trailing Stop الذكي v2.0** يحمي أرباحك بطريقة احترافية:

```
TP1 → Break Even (حماية رأس المال) ✅
TP2 → انتظار (استقرار) ⏸️
TP3+ → تأمين الأرباح التدريجي ✅
```

**الميزة الأساسية:**
بمجرد تحقيق TP1، **لن تخسر أبداً** - الصفقة إما ربح أو Break Even فقط! 🎯

---

**الإصدار:** 2.0
**التاريخ:** 2025-10-16
**الحالة:** ✅ جاهز للاستخدام
